import yara
import os
import git
import subprocess
import glob
import requests
import zipfile
import shutil
import fnmatch


#Clonar repositorio en directorio actual
#git.Git('/home/keepcoding/Desktop/yara_automatico').clone('https://github.com/Yara-Rules/rules.git')


#Actualizar todos los repositorios clonados con pull
#cwd = '/home/keepcoding/Desktop/yara_automatico'

folder = os.path.dirname(os.path.abspath(__file__))
namespace = os.path.join(folder, 'all_rules', 'rules-compiled')


repo_url_a = 'https://github.com/kevoreilly/CAPEv2.git'
repo_url_b = 'https://github.com/Yara-Rules/rules.git'
repo_url_c = 'https://github.com/malice-plugins/yara.git'
repo_url_d = 'https://github.com/mikesxrs/Open-Source-YARA-rules.git'

repo_path_a = '/CAPEv2'
repo_path_b = '/rules'
repo_path_c = '/yara'
repo_path_d = '/Open-Source-YARA-rules'

repo_directory_a = '/home/keepcoding/Desktop/yara_automatico' + repo_path_a
repo_directory_b = '/home/keepcoding/Desktop/yara_automatico' + repo_path_b
repo_directory_c = '/home/keepcoding/Desktop/yara_automatico' + repo_path_c
repo_directory_d = '/home/keepcoding/Desktop/yara_automatico' + repo_path_d

subprocess.run(["git", "pull", repo_url_a], cwd = repo_directory_a)
subprocess.run(["git", "pull", repo_url_b], cwd = repo_directory_b)
subprocess.run(["git", "pull", repo_url_c], cwd = repo_directory_c)
subprocess.run(["git", "pull", repo_url_d], cwd = repo_directory_d)


def copyfiles(src, dst):
    for root, dirs, files in os.walk(folder):
        for filename in files:
            if ('.yara' in filename or '.yar' in filename):
            #content = open(os.path.join(root, filename), 'r').read()
                try:
                    shutil.copy(os.path.join(root, filename), os.path.join(dst, filename))
                except shutil.SameFileError:
                    pass
                
#Esto es lo que estoy probando para renombrar los .yara a .yar, pero acabo de empezar,
#no s√© ni siquiera si este es el sitio adecuado
'''
                old=[]
                new=[]
                for file in dst:
                    if file == '*.yara':
                        old.append(file)
                        new.append(file + '*.yar')
                    os.rename(old, new)
'''          

def compile(filepaths, dst):
    namespace = dict()
    for folder in filepaths:
        for filename in glob.glob('/home/keepcoding/Desktop/yara_automatico/*.yar'):
            name = os.path.basename(os.path.splitext(filename)[0])
            namespace[name] = filename
     
        rules = yara.compile(filepaths = namespace)
        if os.path.exists(dst):
             os.remove(dst)
        rules.save(dst)   


os.makedirs('all_rules', exist_ok=True)
all_rules_folder = os.path.join(folder + '/all_rules')

copyfiles(src=folder, dst=all_rules_folder)
compile(filepaths=all_rules_folder, dst=namespace)




